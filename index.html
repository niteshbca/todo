<!DOCTYPE html>
<html>
<head>
  <title>Inventory PWA</title>
  <style>
    body { font-family: Arial; padding: 20px }
    button { margin: 3px }
  </style>
</head>
<body>

<h2>ðŸ“¦ Inventory</h2>
<div id="items"></div>

<script>
const API = "http://localhost:3000";
let data = JSON.parse(localStorage.getItem("items")) || {};

function save() {
  localStorage.setItem("items", JSON.stringify(data));
}

function render() {
  const box = document.getElementById("items");
  box.innerHTML = "";

  for (let name in data) {
    box.innerHTML += `
      <div>
        <b>${name}</b>: ${data[name].count}
        <button onclick="add('${name}')">+</button>
        <button onclick="sub('${name}')">-</button>
      </div>`;
  }
}

function add(name) {
  data[name] ??= { count: 0, pending: 0 };
  data[name].count++;
  data[name].pending++;
  save(); render();
  if (navigator.onLine) sync(name);
}

function sub(name) {
  if (!data[name] || data[name].count === 0) return;
  data[name].count--;
  data[name].pending--;
  save(); render();
  if (navigator.onLine) sync(name);
}

async function sync(name) {
  if (data[name].pending === 0) return;

  const res = await fetch(API + "/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, delta: data[name].pending })
  });

  const server = await res.json();
  data[name].count = server.count;
  data[name].pending = 0;
  save(); render();
}

async function loadServer() {
  if (!navigator.onLine) return;

  const res = await fetch(API + "/items");
  const items = await res.json();

  items.forEach(i => {
    data[i.name] ??= { count: 0, pending: 0 };
    if (data[i.name].pending === 0)
      data[i.name].count = i.count;
  });

  save();
  render();
}

window.addEventListener("online", loadServer);

["apple","mango","banana"].forEach(n =>
  data[n] ??= { count: 0, pending: 0 }
);

loadServer();
render();
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>

